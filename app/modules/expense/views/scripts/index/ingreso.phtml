<section class="panel">
    <header class="panel-heading" style="padding-bottom : 17px">
        Lista de Proyectos / Actividades
        <span class="pull-right">
            <a id = "guardar_gastos" class="btn btn-success pull-right btn-sm" href="##">
                <i class="fa fa-save"></i> Guardar
            </a>
            <a id = "enviar_gasto" class="btn btn-warning pull-right btn-sm" href="##" style="margin-right : 10px">
                <i class="fa fa-chevron-circle-right"></i> Enviar
            </a>
        </span>
    </header>
</section>

<div class="row">
    <div class="col-sm-12">
    <form action="" id="form_gastos">
    <?php 
    $gasto = $this->gasto;
    if ($gasto) {
        $j = 0;
        foreach ($gasto as $data_gasto) { ?>
            <section class="panel">
                <header class="panel-heading modal-header">
                      <?php echo $data_gasto['proyectoid']. ' - ' .$data_gasto['nombre_proyecto'] ?>
                </header>
                <div class="panel-body">
                    <div class="adv-table">
                        <table  class="display table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th style="width : 70px"></th>
                                    <th>Proyecto / Actividades</th>
                                    <th>Descripción</th>
                                    <th>Tipo de Gasto</th>
                                    <th>Cliente</th>
                                    <th>Reembol.</th>
                                    <th>N° Documento</th>
                                    <th>Proveedor</th>
                                    <th>Monto Neto</th>
                                    <th>Otro Impuesto</th>
                                    <th>IGV</th>
                                    <th>Monto Total</th>
                                </tr>
                            </thead>
                            <tbody>
                            <?php 
                            foreach ($data_gasto['actividades'] as $data_actividades) { ?>
                                <tr class="gradeX">
                                    <td>
                                        <a href="##" class="btn btn-warning btn-xs duplicar_actividad" title="Duplicar" codigo-prop-proy="<?php echo $data_actividades['codigo_prop_proy'] ?>" proyectoid="<?php echo $data_actividades['proyectoid'] ?>" categoriaid="<?php echo $data_actividades['categoriaid'] ?>" areaid = "<?php echo $data_actividades['areaid'] ?>" revision = "<?php echo $data_actividades['revision'] ?>" actividadid = "<?php echo $data_actividades['actividadid'] ?>" cargo = "<?php echo $data_actividades['cargo'] ?>">
                                            <i class="fa fa-plus-square"></i>
                                        </a>
                                        
                                        <a href="##" class="btn btn-danger btn-xs delete_actividad" title="Eliminar" gasto-persona-id = "<?php echo $data_actividades['gasto_persona_id'] ?>">
                                            <i class="fa fa-minus-square"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <?php 
                                        echo ($data_actividades['actividadid'])? $data_actividades['actividadid']. ' - ' .$data_actividades['nombre']: $data_actividades['proyectoid']. ' - ' .$data_actividades['nombre_proyecto'];
                                        ?>
                                    </td>
                                    <td><input name="description[]" type="text" class="form-control" value="<?php echo ($data_actividades['descripcion'])? $data_actividades['descripcion'] : ''; ?>" /></td>
                                    <td>
                                        <select name="tipo_gasto[]" class="list_gasto form-control">
                                            <?php if ($this->list_gastos): ?>
                                                <option value="">Seleccione</option>
                                                <?php foreach ($this->list_gastos as $list_gastos): ?>
                                                    <option value="<?php echo $list_gastos['gastoid'] ?>" <?php print ($data_actividades['gastoid']==$list_gastos['gastoid'])? 'selected' : ''; ?>><?php echo $list_gastos['gastoid'].' - '.$list_gastos['nombre_gasto'] ?></option>
                                                <?php endforeach ?>
                                            <?php else: ?>
                                                <option value="">No Existen Gastos</option>
                                            <?php endif ?>
                                        </select>
                                    </td>
                                    <td>
                                        <center>
                                            <input name="cliente[<?php echo $j?>]" type="checkbox" class="form-control" style="width : 15px" value="TRUE" <?php print ($data_actividades['bill_cliente']=='TRUE')? 'checked' : ''; ?>/>
                                        </center>
                                    </td>
                                    <td>
                                        <center><input name="reembolsable[<?php echo $j?>]" type="checkbox" class="form-control"   style="width : 15px" value="TRUE" <?php print ($data_actividades['reembolsable']=='TRUE')? 'checked' : ''; ?>/></center>
                                    </td>
                                    <td>
                                        <center><input name="documento[]" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['num_factura'])? $data_actividades['num_factura'] : ''; ?>"></center>
                                    </td>
                                    <td>
                                        <center><input name="proveedor[]" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['proveedor'])? $data_actividades['proveedor'] : ''; ?>"></center>
                                    </td>
                                    <td>
                                        <center><input name="monto[]" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['monto_igv'])? $data_actividades['monto_igv'] : ''; ?>"></center>
                                    </td>
                                    <td>
                                        <center><input name="otro_impuesto[]" type="text" class="form-control" style="width : 50px" value="<?php echo ($data_actividades['otro_impuesto'])? $data_actividades['otro_impuesto'] : ''; ?>"></center>
                                    </td>
                                    <td>
                                        <center><input name="igv[]" type="text" class="form-control" style="width : 50px" value="<?php echo ($data_actividades['igv'])? $data_actividades['igv'] : ''; ?>"></center>
                                    </td>
                                    <td>
                                        <center><input name="monto_total[]" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['monto_total'])? $data_actividades['monto_total'] : ''; ?>"></center>
                                    </td>
                                    <input type="hidden" name="gasto_persona_id[]" value="<?php echo $data_actividades['gasto_persona_id'] ?>"/>
                                    <input type="hidden" name="codigo_prop_proy[]" value="<?php echo $data_actividades['codigo_prop_proy'] ?>"/>
                                    <input type="hidden" name="proyectoid[]" value="<?php echo $data_actividades['proyectoid'] ?>"/>
                                </tr>
                            <?php
                            $j++;
                            }
                             ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <?php
        }
    }
     ?>
    </form>
    </div>
</div>
<div id="load_duplicidad"></div>

<script type="text/javascript">
    $(".duplicar_actividad").click(function(){
        var proyectoid = $(this).attr('proyectoid');
        var codigo_prop_proy = $(this).attr('codigo-prop-proy');
        var categoriaid = $(this).attr('categoriaid');
        var areaid = $(this).attr('areaid');
        var cargo = $(this).attr('cargo');
        var revision = $(this).attr('revision');
        var actividadid = $(this).attr('actividadid');
        url = "/expense/index/guardargastopersona/codigo-prop-proy/"+codigo_prop_proy+"/proyectoid/"+proyectoid+"/categoriaid/"+categoriaid+"/areaid/"+areaid+"/cargo/"+cargo+"/revision/"+revision+"/actividadid/"+actividadid;
        $("#load_duplicidad").load(url);
        $("#ingreso").load("/expense/index/ingreso/");
    });

    $(".delete_actividad").click(function(){
        var gasto_persona_id = $(this).attr('gasto-persona-id');
        url = "/expense/index/eliminargastopersona/gasto_persona_id/"+gasto_persona_id;
        $("#load_duplicidad").load(url);
        $("#ingreso").load("/expense/index/ingreso/");
    });

    $('#guardar_gastos').click(function(){
        $.ajax({
            type   : 'post',
            url    : '/expense/index/updategastopersona/',
            data   : $('#form_gastos').serialize(),
            success: function(data){
                alert("El gasto fue registrado.");
            }
        });
    });

    $('#enviar_gasto').click(function(){
        $.ajax({
            type   : 'post',
            url    : '/expense/index/updateenviargastopersona/',
            data   : $('#form_gastos').serialize(),
            success: function(data){
                alert("El gasto fue enviado.");
            }
        });
    });
</script>