<?php 
if ($this->gasto) { 
$data_rendicion = $this->data_rendicion;
    ?>
<div class="row">
<form action="" id="form_rendicion" class="form-horizontal">
    <div class="col-lg-4">
        <section class="panel">
            <div class="panel-body">
                <div class="form-group">
                    <label class="col-lg-4 col-sm-4 control-label" style="font-size : 12px">N° Rendición</label>
                    <div class="col-lg-8">
                    <?php if ($data_rendicion['estado'] == "E") { ?>
                        <span><?php echo $data_rendicion['numero']; ?></span>
                        <?php
                    } else { ?>
                        <input name="numero" type="text" class="form-control" value="<?php echo ($data_rendicion['numero'])? $data_rendicion['numero']: '';?>"/>
                    <?php 
                    } ?>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-lg-4 col-sm-4 control-label" style="font-size : 12px">Título Rendición</label>
                    <div class="col-lg-8">
                    <?php if ($data_rendicion['estado'] == "E") { ?>
                    <span><?php echo $data_rendicion['nombre']; ?></span>
                        <?php
                    } else { ?>
                        <input name="nombre" type="text" class="form-control" value="<?php echo ($data_rendicion['nombre'])? $data_rendicion['nombre']: '';?>"/>
                    <?php 
                    } ?>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-lg-4 col-sm-4 control-label" style="font-size : 12px">Fecha</label>
                    <div class="col-lg-8">
                    <?php if ($data_rendicion['estado'] == "E") { ?>
                    <span><?php echo $data_rendicion['fecha']; ?></span>
                        <?php
                    } else { ?>
                        <input name="fecha_rendicion" type="text" class="form-control" value="<?php echo ($data_rendicion['fecha'])? $data_rendicion['fecha']: '';?>" readonly/>
                    <?php 
                    } ?>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <div class="col-lg-4">
        <section class="panel">
            <div class="panel-body" style="padding : 10x 10px">
                <div class="form-group">
                    <label class="col-lg-6 col-sm-6 control-label" style="font-size : 12px">Total Monto</label>
                    <div class="col-lg-6">
                    <?php if ($data_rendicion['estado'] == "E") { ?>
                    <span><?php echo $data_rendicion['monto_total']; ?></span>
                        <?php
                    } else { ?>
                        <input name="monto_total" type="text" class="form-control" value="<?php echo ($data_rendicion['monto_total'])? $data_rendicion['monto_total']: '';?>"/>
                    <?php 
                    } ?>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-lg-6 col-sm-6 control-label" style="font-size : 12px">Total Reembolso</label>
                    <div class="col-lg-6">
                    <?php if ($data_rendicion['estado'] == "E") { ?>
                    <span><?php echo $data_rendicion['monto_reembolso']; ?></span>
                        <?php
                    } else { ?>
                        <input name="monto_reembolso" type="text" class="form-control" value="<?php echo ($data_rendicion['monto_reembolso'])? $data_rendicion['monto_reembolso']: '';?>"/>
                    <?php 
                    } ?>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-lg-6 col-sm-6 control-label" style="font-size : 12px">Total Cliente</label>
                    <div class="col-lg-6">
                    <?php if ($data_rendicion['estado'] == "E") { ?>
                    <span><?php echo $data_rendicion['monto_cliente']; ?></span>
                        <?php
                    } else { ?>
                        <input name="monto_cliente" type="text" class="form-control" value="<?php echo ($data_rendicion['monto_cliente'])? $data_rendicion['monto_cliente']: '';?>"/>
                    <?php 
                    } ?>
                    </div>
                </div>
            </div>
        </section>
    </div>
</form>
    <?php if ($data_rendicion['estado'] != "E") { ?>
    <div class="col-lg-4">
        <section class="panel">
            <div class="panel-body" style="padding : 28px 15px 28px 15px">
                <a id="guardar_gastos" class="btn btn-success pull-right btn-sm" href="##">
                    <i class="fa fa-save"></i> Guardar
                </a>
                <a id="enviar_gasto" class="btn btn-warning pull-right btn-sm" href="##" style="margin-right : 10px">
                    <i class="fa fa-chevron-circle-right"></i> Enviar
                </a>
            </div>
        </section>
    </div>
    <?php 
    } ?>
</div>

<div class="row">
    <div class="col-sm-12">
    <form action="" id="form_gastos">
    <?php 
    $gasto = $this->gasto;
    if ($gasto) {
        $j = 0;
        foreach ($gasto as $data_gasto) { ?>
            <section class="panel">
                <header class="panel-heading modal-header" style="padding : 7px">
                      <?php echo $data_gasto['proyectoid']. ' - ' .$data_gasto['nombre_proyecto'] ?>
                </header>
                <div class="panel-body">
                    <div class="adv-table">
                        <table class="display table table-bordered table-striped table-condensed" style="font-size:11px">
                            <thead>
                                <tr>
                                    <?php if ($data_rendicion['estado'] != "E") { ?>
                                        <th style="width : 30px"></th>
                                        <?php
                                    } ?>
                                    <th>Proyecto / Actividades</th>
                                    <th>Descripción</th>
                                    <th colspan="3"><center>Gasto</center></th>
                                    <th>Cant.</th>
                                    <th>PU</th>
                                    <th>Clien.</th>
                                    <th>Reemb.</th>
                                    <th>Fecha</th>
                                    <th>N° Documento</th>
                                    <th>Proveedor</th>
                                    <th>Neto</th>
                                    <th>Otro Imp. (%)</th>
                                    <th>IGV (18%)</th>
                                    <th>Monto Total</th>
                                </tr>
                            </thead>
                            <tbody>
                            <?php 
                            foreach ($data_gasto['actividades'] as $data_actividades) { ?>
                                <tr class="gradeX">
                                    <?php if ($data_rendicion['estado'] != "E") { ?>
                                    <td>
                                        <a href="##" class="btn btn-warning btn-xs duplicar_actividad" title="Duplicar" gasto-persona-id="<?php echo $data_actividades['gasto_persona_id'] ?>" proyectoid="<?php echo $data_actividades['proyectoid']?>" codigo-prop-proy="<?php echo $data_actividades['codigo_prop_proy']?>">
                                                <strong>+</strong>
                                        </a>
                                            
                                        <a href="##" class="btn btn-danger btn-xs delete_actividad" title="Eliminar" gasto-persona-id = "<?php echo $data_actividades['gasto_persona_id'] ?>" style="margin-top: 2px">
                                            <strong>-</strong>
                                        </a>
                                    </td>
                                        <?php
                                    } ?>
                                    <td>
                                        <?php 
                                        echo ($data_actividades['actividadid'])? $data_actividades['actividadid']. ' - ' .$data_actividades['nombre']: $data_actividades['proyectoid']. ' - ' .$data_actividades['nombre_proyecto'];
                                        ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['descripcion']; ?></span>
                                            <?php
                                        } else { ?>
                                            <input name="description[]" type="text" class="form-control" value="<?php echo ($data_actividades['descripcion'])? $data_actividades['descripcion'] : ''; ?>" />
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { 
                                            foreach ($this->list_gastos as $kvalue) {
                                                if ($data_actividades['gastoid'] == $kvalue['gastoid']) $nom_tmp = $kvalue['nombre_gasto'];
                                            }
                                            ?>
                                            <span><?php echo $nom_tmp; ?></span>
                                            <?php
                                        } else { ?>
                                            <select name="gasto_padre[]" id="gasto_padre<?php echo $data_actividades['gasto_persona_id'] ?>" class="list_gasto form-control">
                                                <?php if ($this->list_gastos): ?>
                                                    <option value="">Seleccione</option>
                                                    <?php foreach ($this->list_gastos as $list_gastos): ?>
                                                        <option value="<?php echo $list_gastos['gastoid']. '-' .$list_gastos['tipo_gasto'] ?>" <?php print ($data_actividades['gastoid']==$list_gastos['gastoid'])? 'selected' : ''; ?>><?php echo $list_gastos['gastoid'].' - '.$list_gastos['nombre_gasto'] ?></option>
                                                    <?php endforeach ?>
                                                <?php else: ?>
                                                    <option value="">No Existen Gastos</option>
                                                <?php endif ?>
                                            </select>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <select name="gasto_hijo[]" id="gasto_hijo<?php echo $data_actividades['gasto_persona_id'] ?>" class="list_gasto form-control">
                                            <option value="">Seleccione</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select name="gasto_nieto[]" id="gasto_nieto<?php echo $data_actividades['gasto_persona_id'] ?>" class="list_gasto form-control">
                                            <option value="">Seleccione</option>
                                        </select>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['laboratorio_cantidad']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="lab_cantidad[]" type="text" class="form-control" style="width : 50px" value="<?php echo ($data_actividades['laboratorio_cantidad'])? $data_actividades['laboratorio_cantidad'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['laboratorio_PU']; ?></span>
                                            <?php
                                            } else { ?>
                                            <center><input name="lab_pu[]" type="text" class="form-control" style="width : 50px" value="<?php echo ($data_actividades['laboratorio_PU'])? $data_actividades['laboratorio_PU'] : ''; ?>"/></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo ($data_actividades['bill_cliente'] == 'TRUE')? 'Si': 'No'; ?></span>
                                            <?php
                                        } else { ?>
                                            <center>
                                                <input name="cliente[<?php echo $j?>]" type="checkbox" class="form-control" style="width : 15px" value="TRUE" <?php print ($data_actividades['bill_cliente']=='TRUE')? 'checked' : ''; ?>/>
                                            </center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo ($data_actividades['reembolsable'] == 'TRUE')? 'Si': 'No'; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="reembolsable[<?php echo $j?>]" type="checkbox" class="form-control"   style="width : 15px" value="TRUE" <?php print ($data_actividades['reembolsable']=='TRUE')? 'checked' : ''; ?>/></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['fecha_factura']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="fecha[]" type="text" class="form-control datefactura" style="width : 70px" value="<?php echo ($data_actividades['fecha_factura'])? $data_actividades['fecha_factura'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['num_factura']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="documento[]" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['num_factura'])? $data_actividades['num_factura'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['proveedor']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="proveedor[]" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['proveedor'])? $data_actividades['proveedor'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['monto_igv']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="monto[]" id="neto<?php echo $data_actividades['gasto_persona_id'] ?>" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['monto_igv'])? $data_actividades['monto_igv'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['otro_impuesto']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="otro_impuesto[]" id="otro_imp<?php echo $data_actividades['gasto_persona_id'] ?>" type="text" class="form-control" style="width : 50px" value="<?php echo ($data_actividades['otro_impuesto'])? $data_actividades['otro_impuesto'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['igv']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="igv[]" id="igv<?php echo $data_actividades['gasto_persona_id'] ?>" type="text" class="form-control" style="width : 50px" value="<?php echo ($data_actividades['igv'])? $data_actividades['igv'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <td>
                                        <?php if ($data_rendicion['estado'] == "E") { ?>
                                            <span><?php echo $data_actividades['monto_total']; ?></span>
                                            <?php
                                        } else { ?>
                                            <center><input name="monto_total[]" id="total<?php echo $data_actividades['gasto_persona_id'] ?>" type="text" class="form-control" style="width : 70px" value="<?php echo ($data_actividades['monto_total'])? $data_actividades['monto_total'] : ''; ?>"></center>
                                        <?php
                                        } ?>
                                    </td>
                                    <input type="hidden" name="gasto_persona_id[]" value="<?php echo $data_actividades['gasto_persona_id'] ?>"/>
                                    <input type="hidden" name="codigo_prop_proy[]" value="<?php echo $data_actividades['codigo_prop_proy'] ?>"/>
                                    <input type="hidden" name="proyectoid[]" value="<?php echo $data_actividades['proyectoid'] ?>"/>
                                </tr>
                                <script type="text/javascript">
                                    $("#neto<?php echo $data_actividades['gasto_persona_id'] ?>").keyup(function(){
                                        var neto = $(this).val();
                                        var otro = $("#otro_imp<?php echo $data_actividades['gasto_persona_id'] ?>").val();
                                        if (otro == '' || otro =='0') {
                                            var igv = (neto * 0.18);
                                        } else {
                                            var other_igv = (neto *(otro/100))
                                            var new_neto = parseFloat(neto)+parseFloat(other_igv);
                                            var igv = (new_neto * 0.18);
                                        };
                                        var total = parseFloat(neto)+parseFloat(igv);
                                        $("#igv<?php echo $data_actividades['gasto_persona_id'] ?>").val(igv);
                                        $("#total<?php echo $data_actividades['gasto_persona_id'] ?>").val(total);
                                    });

                                    $("#otro_imp<?php echo $data_actividades['gasto_persona_id'] ?>").keyup(function(){
                                        var neto = $("#neto<?php echo $data_actividades['gasto_persona_id'] ?>").val();
                                        var otro = $(this).val();
                                        if (otro == '' || otro =='0') {
                                            var igv = (neto * 0.18);
                                        } else {
                                            var other_igv = (neto *(otro/100))
                                            var new_neto = parseFloat(neto)+parseFloat(other_igv);
                                            var igv = (new_neto * 0.18);
                                        };
                                        var total = parseFloat(neto)+parseFloat(igv);
                                        $("#igv<?php echo $data_actividades['gasto_persona_id'] ?>").val(igv);
                                        $("#total<?php echo $data_actividades['gasto_persona_id'] ?>").val(total);
                                    });

                                    $("#gasto_padre<?php echo $data_actividades['gasto_persona_id'] ?>").change(function(){
                                        var gasto_padre = $(this).val();
                                        $("#gasto_hijo<?php echo $data_actividades['gasto_persona_id'] ?>").load("/expense/index/gastohijo/gastoid/"+gasto_padre);
                                    });

                                    $("#gasto_hijo<?php echo $data_actividades['gasto_persona_id'] ?>").change(function(){
                                        var gasto_nieto = $(this).val();
                                        $("#gasto_nieto<?php echo $data_actividades['gasto_persona_id'] ?>").load("/expense/index/gastonieto/gastoid/"+gasto_nieto);
                                    });
                                </script>
                            <?php
                            $j++;
                            }
                             ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <?php
        }
    }
     ?>
    </form>
    </div>
</div>
<div id="load_duplicidad"></div>

<script type="text/javascript">
    $(".datefactura").datepicker();

    $(".duplicar_actividad").click(function(){
        var gasto_persona_id = $(this).attr('gasto-persona-id');
        var proyectoid = $(this).attr('proyectoid');
        var codigo_prop_proy = $(this).attr('codigo-prop-proy');

        $.ajax({
            type   : 'post',
            url    : '/expense/index/updategastorendicion/',
            data   : $('#form_rendicion').serialize(),
            success: function(data){
                $.ajax({
                    type   : 'post',
                    url    : '/expense/index/updategastopersona/',
                    data   : $('#form_gastos').serialize(),
                    success: function(data){
                        var url2 = "/expense/index/duplicargastopersona/gasto_persona_id/"+gasto_persona_id+"/proyectoid/"+proyectoid+"/codigo_prop_proy/"+codigo_prop_proy;
                        $("#load_duplicidad").load(url2);
                        $("#ingreso").load("/expense/index/ingreso/");
                    }
                });
            }
        });
    });

    $(".delete_actividad").click(function(){
        var gasto_persona_id = $(this).attr('gasto-persona-id');
        url = "/expense/index/eliminargastopersona/gasto_persona_id/"+gasto_persona_id;
        $("#load_duplicidad").load(url);
        $("#ingreso").load("/expense/index/ingreso/");
    });

    $('#guardar_gastos').click(function(){
        $.ajax({
            type   : 'post',
            url    : '/expense/index/updategastorendicion/',
            data   : $('#form_rendicion').serialize(),
            success: function(data){
                $.ajax({
                    type   : 'post',
                    url    : '/expense/index/updategastopersona/',
                    data   : $('#form_gastos').serialize(),
                    success: function(data){
                        alert("El gasto fue registrado.");
                    }
                });
            }
        });
    });

    $('#enviar_gasto').click(function(){
        $.ajax({
            type   : 'post',
            url    : '/expense/index/updateenviargastorendicion/',
            data   : $('#form_rendicion').serialize(),
            success: function(data){
                $.ajax({
                    type   : 'post',
                    url    : '/expense/index/updateenviargastopersona/',
                    data   : $('#form_gastos').serialize(),
                    success: function(data){
                        alert("El gasto fue enviado.");
                        window.location.reload();
                    }
                });
            }
        });
    });
</script>

<?php 
} ?>